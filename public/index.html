<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>24/7 Chat & Call</title>
<style>
  body {
    margin: 0; padding: 0; font-family: Arial, sans-serif;
    background-color: #121212;
    color: #ddd;
    display: flex; flex-direction: column; height: 100vh;
  }
  #loginScreen, #chatScreen {
    margin: auto; width: 100%; max-width: 600px;
  }
  #loginScreen {
    display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;
  }
  #loginScreen input {
    font-size: 1.2rem; padding: 10px;
    width: 200px; border-radius: 4px; border: none;
  }
  #loginScreen button {
    margin-top: 10px; font-size: 1.2rem;
    padding: 10px 20px; border: none; border-radius: 4px;
    background-color: #1e88e5; color: white; cursor: pointer;
  }

  #chatScreen {
    display: none; flex-direction: column; height: 100vh;
  }

  #usersOnline {
    padding: 10px;
    background: #1f1f1f;
    border-bottom: 1px solid #333;
  }
  #usersOnline span {
    margin-right: 10px;
    cursor: default;
  }

  #messages {
    flex-grow: 1;
    padding: 10px;
    overflow-y: auto;
    background: #181818;
  }
  .message {
    margin-bottom: 10px;
    border-radius: 5px;
    padding: 5px 10px;
    background: #222;
  }
  .message .author {
    font-weight: bold;
  }
  .message .text {
    margin-top: 3px;
    word-wrap: break-word;
    max-width: 80%;
  }
  .message img, .message video {
    margin-top: 5px;
    max-width: 200px;
    border-radius: 5px;
  }
  .message .seen {
    font-size: 0.7rem;
    color: #888;
    margin-top: 3px;
  }

  #inputArea {
    background: #1f1f1f;
    padding: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  #inputArea input[type="text"] {
    flex-grow: 1;
    font-size: 1rem;
    padding: 8px;
    border-radius: 4px;
    border: none;
  }
  #inputArea input[type="file"] {
    color: white;
  }
  #inputArea button {
    background: #1e88e5;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    color: white;
    cursor: pointer;
  }

  #videos {
    display: flex;
    justify-content: space-around;
    background: #000;
    padding: 5px;
  }
  video {
    max-height: 150px;
    border-radius: 8px;
    background: black;
  }

  #callControls {
    display: flex;
    justify-content: center;
    padding: 10px;
    background: #1f1f1f;
    gap: 10px;
  }
  #callControls button {
    padding: 8px 15px;
    background: #2196f3;
    border: none;
    border-radius: 5px;
    color: white;
    cursor: pointer;
  }
</style>
</head>
<body>

<div id="loginScreen">
  <h2>Login</h2>
  <input type="text" id="usernameInput" placeholder="Enter username: Galaad or Skull" />
  <button id="loginBtn">Login</button>
</div>

<div id="chatScreen">
  <div id="usersOnline"><strong>Users online:</strong> <span id="usersOnlineSpan"></span></div>
  <div id="messages"></div>

  <div id="inputArea">
    <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off" />
    <input type="file" id="fileInput" accept="image/*,video/*,.gif" />
    <button id="sendBtn">Send</button>
  </div>

  <div id="videos">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>

  <div id="callControls">
    <button id="callBtn">Start Call</button>
    <button id="screenShareBtn">Share Screen</button>
    <button id="hangupBtn" style="display:none;">Hang Up</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script>
  const socket = io();

  // UI refs
  const loginScreen = document.getElementById('loginScreen');
  const chatScreen = document.getElementById('chatScreen');
  const usernameInput = document.getElementById('usernameInput');
  const loginBtn = document.getElementById('loginBtn');
  const usersOnlineSpan = document.getElementById('usersOnlineSpan');
  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const fileInput = document.getElementById('fileInput');
  const sendBtn = document.getElementById('sendBtn');
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');
  const callBtn = document.getElementById('callBtn');
  const screenShareBtn = document.getElementById('screenShareBtn');
  const hangupBtn = document.getElementById('hangupBtn');

  let username = null;
  let peer = null;
  let localStream = null;
  let userSocketMap = {};

  // Login logic
  loginBtn.onclick = () => {
    const val = usernameInput.value.trim();
    if (val !== 'Galaad' && val !== 'Skull') {
      alert('Invalid username! Use Galaad or Skull.');
      return;
    }
    username = val;
    socket.emit('login', username);
    loginScreen.style.display = 'none';
    chatScreen.style.display = 'flex';
  };

  // Update users online list
  socket.on('usersOnline', (list) => {
    usersOnlineSpan.innerHTML = '';
    list.forEach(user => {
      const span = document.createElement('span');
      span.textContent = user;
      span.style.marginRight = '10px';
      span.id = 'user-' + user;
      usersOnlineSpan.appendChild(span);
    });
  });

  // Update userSocketMap
  socket.on('userSocketMap', (map) => {
    userSocketMap = map;
  });

  // Message sending
  sendBtn.onclick = sendMessage;
  messageInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

  function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;
    const msg = { id: Date.now(), author: username, text, seenBy: [] };
    socket.emit('message', msg);
    messageInput.value = '';
  }

  // File upload & send
  fileInput.onchange = () => {
    const file = fileInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    fetch('/upload', { method: 'POST', body: formData })
      .then(res => res.json())
      .then(data => {
        let msgText = '';
        if (file.type.startsWith('image/')) msgText = `<img src="${data.url}" alt="img" />`;
        else if (file.type.startsWith('video/') || file.name.endsWith('.gif')) msgText = `<video src="${data.url}" autoplay muted loop></video>`;
        else msgText = 'Unsupported file type';

        const msg = { id: Date.now(), author: username, text: msgText, seenBy: [] };
        socket.emit('message', msg);
        fileInput.value = '';
      })
      .catch(() => alert('Upload failed'));
  };

  // Receive messages
  socket.on('message', (msg) => {
    addMessageToChat(msg);
  });

  // Receive history on login
  socket.on('history', (history) => {
    messagesDiv.innerHTML = '';
    history.forEach(addMessageToChat);
  });

  // Add message to chat DOM
  function addMessageToChat(msg) {
    const div = document.createElement('div');
    div.className = 'message';
    div.innerHTML = `<span class="author">${msg.author}:</span> <span class="text">${msg.text}</span>`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // --- Call logic ---

  // Helpers to get other user info
  function getOtherUsername() {
    const users = Object.keys(userSocketMap);
    return users.find(u => u !== username);
  }
  function getOtherSocketId() {
    const other = getOtherUsername();
    if (!other) return null;
    return userSocketMap[other];
  }

  // Audio volume detection to set bold user name
  function monitorAudioStream(user, stream) {
    try {
      const audioCtx = new AudioContext();
      const analyser = audioCtx.createAnalyser();
      analyser.fftSize = 512;
      const source = audioCtx.createMediaStreamSource(stream);
      source.connect(analyser);
      const dataArray = new Uint8Array(analyser.frequencyBinCount);

      function checkVolume() {
        analyser.getByteFrequencyData(dataArray);
        const volume = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
        const span = document.getElementById('user-' + user);
        if (!span) return;
        if (volume > 30) span.style.fontWeight = 'bold';
        else span.style.fontWeight = 'normal';
        requestAnimationFrame(checkVolume);
      }
      checkVolume();
    } catch (e) {
      // AudioContext failed or no mic, ignore
    }
  }

  // Start call, screenShare = true si partage Ã©cran
  function startCall(screenShare = false) {
    if (peer) {
      alert('Call already in progress');
      return;
    }

    const constraints = { audio: true };
    if (!screenShare) {
      const wantsCam = confirm('Do you want to share your webcam video?');
      if (wantsCam) constraints.video = true;
    }

    navigator.mediaDevices.getUserMedia(constraints).then(audioStream => {
      if (screenShare) {
        navigator.mediaDevices.getDisplayMedia({ video: true }).then(screenStream => {
          localStream = new MediaStream([...audioStream.getAudioTracks(), ...screenStream.getVideoTracks()]);
          setupPeer(localStream);
        }).catch(() => {
          localStream = audioStream;
          setupPeer(localStream);
        });
      } else {
        localStream = audioStream;
        setupPeer(localStream);
      }
    }).catch(() => alert('Could not get media'));
  }

  function setupPeer(stream) {
    peer = new SimplePeer({
      initiator: true,
      trickle: false,
      stream: stream
    });

    localVideo.srcObject = stream;
    localVideo.muted = true;
    localVideo.play();

    monitorAudioStream(username, stream);

    const otherId = getOtherSocketId();
    if (!otherId) {
      alert('No other user online');
      return;
    }

    peer.on('signal', data => {
      socket.emit('callUser', { to: otherId, signal: data });
    });

    peer.on('stream', remoteStream => {
      remoteVideo.srcObject = remoteStream;
      remoteVideo.play();
      const otherName = getOtherUsername();
      monitorAudioStream(otherName, remoteStream);
    });

    peer.on('close', endCall);
    peer.on('error', endCall);

    hangupBtn.style.display = 'inline-block';
  }

  // Answer incoming call
  socket.on('incomingCall', ({ from, signal }) => {
    if (peer) {
      socket.emit('rejectCall', userSocketMap[from]);
      return;
    }
    if (!confirm(`${from} is calling you. Accept?`)) {
      socket.emit('rejectCall', userSocketMap[from]);
      return;
    }

    const constraints = { audio: true };
    if (confirm('Do you want to share your webcam video?')) constraints.video = true;

    navigator.mediaDevices.getUserMedia(constraints).then(stream => {
      localStream = stream;
      peer = new SimplePeer({
        initiator: false,
        trickle: false,
        stream
      });
      localVideo.srcObject = stream;
      localVideo.muted = true;
      localVideo.play();

      monitorAudioStream(username, stream);

      peer.on('signal', data => {
        socket.emit('answerCall', { to: userSocketMap[from], signal: data });
      });
      peer.on('stream', remoteStream => {
        remoteVideo.srcObject = remoteStream;
        remoteVideo.play();
        monitorAudioStream(from, remoteStream);
      });
      peer.on('close', endCall);
      peer.on('error', endCall);

      peer.signal(signal);
      hangupBtn.style.display = 'inline-block';
    }).catch(() => alert('Could not get media'));
  });

  // When call is answered
  socket.on('callAnswered', (signal) => {
    if (peer) peer.signal(signal);
  });

  // Reject call
  socket.on('callRejected', () => {
    alert('Call rejected');
    endCall();
  });

  // Call disconnected
  socket.on('callDisconnected', () => {
    alert('Call ended');
    endCall();
  });

  // Hangup button
  hangupBtn.onclick = () => {
    if (peer) {
      const otherId = getOtherSocketId();
      if (otherId) socket.emit('disconnectCall', otherId);
      endCall();
    }
  };

  function endCall() {
    if (peer) {
      peer.destroy();
      peer = null;
    }
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
      localStream = null;
    }
    localVideo.srcObject = null;
    remoteVideo.srcObject = null;
    hangupBtn.style.display = 'none';

    // Reset user name style bold
    Array.from(usersOnlineSpan.children).forEach(span => {
      span.style.fontWeight = 'normal';
    });
  }

  // Buttons call
  callBtn.onclick = () => startCall(false);
  screenShareBtn.onclick = () => startCall(true);

</script>

</body>
</html>
